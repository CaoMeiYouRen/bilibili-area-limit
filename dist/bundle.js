
// ==UserScript==
// @name               Bilibili 港澳台
// @namespace          http://kghost.info/
// @version            1.3.3
// @description:       Remove area restriction
// @description:zh-CN  解除区域限制 (修正大会员限制，添加国际友人看国内功能)
// @supportURL         https://github.com/kghost/bilibili-area-limit
// @author             zealot0630
// @include            https://*.bilibili.com/*
// @run-at document-start
// @description Bilibili 港澳台, 解除区域限制 (修正大会员限制，添加国际友人看国内功能)
// @grant       GM_notification
// @grant       GM_cookie
// @grant       GM.setValue
// @grant       GM.getValue
// ==/UserScript==

(function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{enumerable:!0,get:d})},b.r=function(a){'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(a,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(a,'__esModule',{value:!0})},b.t=function(a,c){if(1&c&&(a=b(a)),8&c)return a;if(4&c&&'object'==typeof a&&a&&a.__esModule)return a;var d=Object.create(null);if(b.r(d),Object.defineProperty(d,'default',{enumerable:!0,value:a}),2&c&&'string'!=typeof a)for(var e in a)b.d(d,e,function(b){return a[b]}.bind(null,e));return d},b.n=function(a){var c=a&&a.__esModule?function(){return a['default']}:function(){return a};return b.d(c,'a',c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p='',b(b.s='./src/main.js')})({"./src/main.js":function(a,b,c){'use strict';c.r(b);var d=c('./src/url.js');(function(a){const b=Symbol('ProxyGetTarget'),c=Symbol('ProxyGetHandler');class e{constructor(a){this.target=a}get(a,d,e){if(a.hasOwnProperty(d))return Reflect.get(a,d,e);if(d==b)return a;if(d==c)return this;else{const b=a[d];return'function'==typeof b?new Proxy(b,new g(b)):b}}set(a,b,c){return Reflect.set(a,b,c)}}class f extends e{apply(a,c,d){const e=c[b];if(!e)throw new Error('illegal invocations');return this.call(this.target,c,e,d)}}class g extends f{call(a,b,c,d){return a.apply(c,d)}}class h extends e{constructor(a){super(a),this.listeners={}}getListeners(a){return this.listeners.hasOwnProperty(a)||(this.listeners[a]=new Map),this.listeners[a]}get(a,b,c){return'addEventListener'===b?new Proxy(a.addEventListener,new this.addEventListener(a.addEventListener)):'removeEventListener'===b?new Proxy(a.removeEventListener,new this.removeEventListener(a.removeEventListener)):super.get(a,b,c)}}h.prototype.addEventListener=class extends f{call(a,b,d,e){const f=e[0],g=e[1],h=g.bind(b);return e[1]=h,b[c].getListeners(f).set(g,h),a.apply(d,e)}},h.prototype.removeEventListener=class extends f{call(a,b,d,e){const f=e[0],g=e[1],h=b[c].getListeners(f);return h.has(g)&&(e[1]=h.get(g),h.delete(g)),a.apply(d,e)}};class i extends h{constructor(a){super(a),this.overrideResponse=!1,this.overrideResponseValue=null}get(a,b,c){return'open'===b?new Proxy(a.open,new this.open(a.open)):'send'===b?new Proxy(a.send,new this.send(a.send)):'response'===b&&this.overrideResponse?(console.log('BAL: Return hooked area limit'),this.overrideResponseValue):'responseText'===b&&this.overrideResponse?(console.log('BAL: Return hooked area limit'),this.overrideResponseValue):super.get(a,b,c)}}const j=()=>{GM.getValue('__area__limit__',0).then((a)=>{a>new Date().getTime()-864e5||(confirm('Bilibili\u3000\u6E2F\u6FB3\u53F0: \u65E0\u6CD5\u83B7\u53D6\u64AD\u653E\u6587\u4EF6\u4FE1\u606F\uFF0C\u5982\u679C\u5DF2\u5F00\u901A\u5927\u4F1A\u5458\uFF0C\u8BF7\u5347\u7EA7\u6CB9\u7334\u5230BETA\u7248\u672C')?window.open('https://chrome.google.com/webstore/detail/tampermonkey-beta/gcalenpjmijncebpfijmoaglllgpjagf','_blank'):GM.setValue('__area__limit__',new Date().getTime()))})};let k=!1;i.prototype.open=class extends f{call(a,b,e,f){const g=f[0],h=f[1];if('GET'===g)if(k&&h.match(d.url_play))for(const[a,b]of d.url_replace_to){if(function(){for(const b of a)if(document.title.match(b))return!0;return!1}()){f[1]=h.replace(d.url_api_replace,b.api),e.hookCookie=!0,console.log(`BAL: playurl via proxy ${b.api}.`);break}}else(function(){for(const a of d.url_status)if(h.match(a))return!0})()&&e.addEventListener('readystatechange',()=>{if(4===e.readyState&&200===e.status){const a=JSON.parse(e.response);a&&a.result&&1===a.result.area_limit&&(a.result.area_limit=0,k=!0,console.log('BAL: Hook area limit'),b[c].overrideResponse=!0,b[c].overrideResponseValue=JSON.stringify(a))}});return a.apply(e,f)}},i.prototype.send=class extends f{call(a,b,c,d){c.hookCookie?GM_cookie.list({domain:'.bilibili.com',name:'SESSDATA'},(b,e)=>{e?(console.log('BAL: Error fetch cookie, not login'),c.addEventListener('readystatechange',()=>{if(4===c.readyState&&200===c.status){const a=JSON.parse(c.response);-10403==a.code&&j()}}),a.apply(c,d)):(console.log(`BAL: Get Cookie ${b}`),c.setRequestHeader('X-Cookie',b[0].value),a.apply(c,d))}):a.apply(c,d)}},unsafeWindow.XMLHttpRequest=new Proxy(a,new class{constructor(a){this.proxy=a}construct(a,b){const c=new a(...b);return new Proxy(c,new this.proxy(c))}}(i)),(()=>{var a;Object.defineProperty(unsafeWindow,'__PGC_USERSTATE__',{configurable:!0,get:()=>a,set:(b)=>{1==b.area_limit&&(console.log('BAL: modify area_limit = 0'),k=!0,b.area_limit=0),a=b}})})(),window.addEventListener('load',()=>{if(document.querySelector('div.error-body')){console.log('BAL: Load failed, try use proxy');for(const[a,b]of d.url_replace_to){const a=new unsafeWindow.XMLHttpRequest,c=window.location.href.replace(d.url_www_replace,b.www);a.open('HEAD',c),a.hookCookie=!0,a.onreadystatechange=function(){this.readyState===a.DONE&&204===this.status&&(console.log(`BAL: Redirected to ${b.www}.`),window.location=a.getResponseHeader('X-Location'))},a.send()}}})})(XMLHttpRequest)},"./src/url.js":function(a,b,c){'use strict';c.r(b),c.d(b,'url_status',function(){return d}),c.d(b,'url_play',function(){return e}),c.d(b,'url_api_replace',function(){return f}),c.d(b,'url_www_replace',function(){return g}),c.d(b,'url_replace_to',function(){return h});const d=[/^https:\/\/bangumi\.bilibili\.com\/view\/web_api\/season\/user\/status\?.*/,/^https:\/\/api\.bilibili\.com\/pgc\/view\/web\/season\/user\/status\?.*/],e=/^https:\/\/api\.bilibili\.com\/pgc\/player\/web\/playurl\?.*/,f=/^https:\/\/api\.bilibili\.com\//,g=/^https:\/\/www\.bilibili\.com\//,h=[[[/僅.*港/],{www:'https://bilibili-hk-www.kghost.info/',api:'https://bilibili-hk-api.kghost.info/'}],[[/僅.*台/],{www:'https://bilibili-tw-www.kghost.info/',api:'https://bilibili-tw-api.kghost.info/'}],[[/仅限东南亚/],{www:'https://bilibili-sg-www.kghost.info/',api:'https://bilibili-sg-api.kghost.info/'}],[[/^((?!僅).)*$/],{www:'https://bilibili-cn-www.kghost.info/',api:'https://bilibili-cn-api.kghost.info/'}]]}});
//# sourceMappingURL=bundle.js.map